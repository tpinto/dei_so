#include "lasttweet.h"#include <pthread.h>#define DEBUGtypedef struct {  char* content;  char* keyword;} tweet_t;static pthread_mutex_t using_buffer_mutex = PTHREAD_MUTEX_INITIALIZER;static pthread_t** threads;static tweet_t** tweets;static pthread_cond_t full_buffer = PTHREAD_COND_INITIALIZER;static pthread_cond_t proceed = PTHREAD_COND_INITIALIZER;static int buffer_index;static int how_many_threads;void *Workout(void * k){  char * keyword = (char *) k;    #ifdef DEBUG    printf("Workout(): Started\n");  #endif  while(1){    #ifdef DEBUG      printf("Workout(): Before lock\n");    #endif    pthread_mutex_lock(&using_buffer_mutex);    #ifdef DEBUG      printf("Workout(): After lock\n");    #endif            #ifdef DEBUG      printf("Workout(): buffer_index (%d) == (%d) how_many_threads\n",buffer_index, how_many_threads);    #endif        while(buffer_index == how_many_threads){      pthread_cond_signal(&full_buffer);      pthread_cond_wait(&proceed, &using_buffer_mutex);    }        tweet_t* tweet = (tweet_t*) malloc(sizeof(tweet_t));    tweet->content = lasttweet(keyword);    tweet->keyword = keyword;        tweets[buffer_index] = tweet;    buffer_index = buffer_index + 1;        #ifdef DEBUG      printf("Workout(): after getting tweet\n");      printf("Workout():   buffer_index = %d\n", buffer_index);      printf("Workout():   tweet.content = %s\n", tweet->content);      printf("Workout():   tweet.keyword = %s\n", tweet->keyword);    #endif        #ifdef DEBUG      printf("Workout(): Before unlock\n");    #endif    pthread_mutex_unlock(&using_buffer_mutex);    #ifdef DEBUG      printf("Workout(): After unlock\n");    #endif    sleep(1);  }  pthread_exit(NULL);}int main (int argc, char const *argv[]){  how_many_threads = argc - 1;    #ifdef DEBUG    printf("main(): Lets start %d threads\n", how_many_threads);  #endif    threads = malloc(how_many_threads*sizeof(pthread_t));  tweets = malloc(how_many_threads*sizeof(tweet_t));      buffer_index = 0;  int i;  pthread_t thread;  for(i=1;i<argc;i++){    #ifdef DEBUG      printf("main(): Creating thread #%d for keyword '%s'\n",i,argv[i]);    #endif    pthread_create(&thread, NULL, Workout, (void *) argv[i]);        #ifdef DEBUG      printf("main(): Created thread #%d for keyword '%s'\n",i,argv[i]);    #endif        threads[i] = &thread;        #ifdef DEBUG      printf("main(): Created thread #%d for keyword '%s'\n",i,argv[i]);    #endif  }    while(1){    #ifdef DEBUG      printf("main(): Before lock\n");    #endif    pthread_mutex_lock(&using_buffer_mutex);    #ifdef DEBUG      printf("main(): After lock\n");    #endif        #ifdef DEBUG      printf("main(): buffer_index (%d) != (%d) how_many_threads\n",buffer_index,how_many_threads);    #endif    while(buffer_index != how_many_threads)      pthread_cond_wait(&full_buffer, &using_buffer_mutex);    while(buffer_index > 0){      tweet_t* tweet = (tweet_t*) malloc(sizeof(tweet_t));      tweet = tweets[buffer_index];      buffer_index = buffer_index - 1;      printf("main(): tweet for '%s': %s", tweet->keyword, tweet->content);    }    #ifdef DEBUG      printf("main(): Before unlock\n");    #endif    pthread_cond_broadcast(&proceed);    pthread_mutex_unlock(&using_buffer_mutex);    #ifdef DEBUG      printf("main(): After unlock\n");    #endif  }    return 0;}