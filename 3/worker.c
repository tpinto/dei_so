#include "lasttweet.h"#include <pthread.h>#include <signal.h>//#define DEBUGtypedef struct {  char *content;  char *keyword;} tweet_t;static pthread_mutex_t using_buffer_mutex = PTHREAD_MUTEX_INITIALIZER;static pthread_t** threads;static tweet_t** tweets;static pthread_t consumer_thread;static pthread_cond_t full_buffer = PTHREAD_COND_INITIALIZER;static pthread_cond_t proceed = PTHREAD_COND_INITIALIZER;static int working = 1;static int buffer_index;static int how_many_threads;void quit(){  printf("Quitting...\n");  working = 0;  pthread_exit(NULL);  pthread_mutex_destroy(&using_buffer_mutex);  pthread_cond_destroy(&full_buffer);  pthread_cond_destroy(&proceed);  exit(0);}void *Consume(void * k){  while(working){    #ifdef DEBUG      printf("main(): Before lock\n");    #endif    pthread_mutex_lock(&using_buffer_mutex);    #ifdef DEBUG      printf("main(): After lock\n");    #endif        #ifdef DEBUG      printf("main(): buffer_index (%d) != (%d) how_many_threads\n",buffer_index,how_many_threads);    #endif    while(buffer_index < how_many_threads)      pthread_cond_wait(&full_buffer, &using_buffer_mutex);    #ifdef DEBUG      printf("main(): depois do cond wait\n");    #endif        int i;    for(i=0;i<how_many_threads;i++){      #ifdef DEBUG        printf("main(): getting tweet for buffer_index=%d\n",buffer_index);      #endif            tweet_t* t = tweets[i];            printf("main(): tweet for '%s': %s\n\n", t->keyword, t->content);    }        buffer_index = 0;    #ifdef DEBUG      printf("main(): Before unlock\n");    #endif    pthread_cond_broadcast(&proceed);    pthread_mutex_unlock(&using_buffer_mutex);    #ifdef DEBUG      printf("main(): After unlock\n");    #endif  }    return NULL;  //pthread_exit(NULL);}void *Produce(void * k){  char * keyword = (char *) k;    #ifdef DEBUG    printf("Thread '%s', Workout(): Started\n", keyword);  #endif  while(working){    #ifdef DEBUG      printf("Thread '%s', Workout(): Before lock\n", keyword);    #endif    pthread_mutex_lock(&using_buffer_mutex);    #ifdef DEBUG      printf("Thread '%s', Workout(): After lock\n", keyword);    #endif            #ifdef DEBUG      printf("Thread '%s', Workout(): buffer_index (%d) == (%d) how_many_threads\n", keyword,buffer_index, how_many_threads);    #endif        while(buffer_index == how_many_threads){      pthread_cond_signal(&full_buffer);      pthread_cond_wait(&proceed, &using_buffer_mutex);    }        tweet_t* tweet = (tweet_t*) malloc(sizeof(tweet_t));    tweet->content = lasttweet(keyword);    tweet->keyword = keyword;        #ifdef DEBUG      printf("Thread '%s', Workout(): after getting tweet\n");      printf("Thread '%s', Workout():   buffer_index = %d\n", keyword, buffer_index);      printf("Thread '%s', Workout():   tweet.content = %s\n", keyword, tweet->content);      printf("Thread '%s', Workout():   tweet.keyword = %s\n", keyword, tweet->keyword);    #endif        tweets[buffer_index] = tweet;    buffer_index = buffer_index + 1;             #ifdef DEBUG      printf("Thread '%s', Workout(): Before unlock\n", keyword);    #endif    pthread_mutex_unlock(&using_buffer_mutex);    #ifdef DEBUG      printf("Thread '%s', Workout(): After unlock\n", keyword);    #endif    //sleep(1);  }    #ifdef DEBUG    printf("Thread '%s', Exiting\n", keyword);  #endif  return NULL;  //pthread_exit(NULL);}int main (int argc, char const *argv[]){  how_many_threads = argc - 1;    #ifdef DEBUG    printf("main(): Lets start %d threads\n", how_many_threads);  #endif    threads = malloc(how_many_threads*sizeof(pthread_t*));  tweets = malloc(how_many_threads*sizeof(tweet_t*));      buffer_index = 0;  int i;  pthread_t thread;  for(i=1;i<argc;i++){    #ifdef DEBUG      printf("main(): Creating thread #%d for keyword '%s'\n",i,argv[i]);    #endif    pthread_create(&thread, NULL, Produce, (void *) argv[i]);        #ifdef DEBUG      printf("main(): Created thread #%d for keyword '%s'\n",i,argv[i]);    #endif        threads[i] = &thread;        #ifdef DEBUG      printf("main(): Created thread #%d for keyword '%s'\n",i,argv[i]);    #endif  }    pthread_create(&consumer_thread, NULL, Consume, NULL);    sigset_t set;  int sig;    sigemptyset(&set);  sigaddset(&set, SIGINT);  pthread_sigmask(SIG_BLOCK, &set, NULL);    while(1){    sigwait(&set, &sig);    switch(sig){      case SIGINT:        quit();      default:        pthread_exit((void *)-1);    }  }      return 0;}